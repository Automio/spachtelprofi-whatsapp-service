version: "3.8"

services:
  # n8n workflow automation
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    restart: always
    ports:
      - "5678:5678"
    environment:
      # Basic Configuration
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production

      # Webhook Configuration (REQUIRED for WhatsApp)
      - WEBHOOK_URL=https://${N8N_HOST}/

      # Timezone
      - GENERIC_TIMEZONE=${TIMEZONE:-Europe/Berlin}

      # Database (recommended for production)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB:-n8n}
      - DB_POSTGRESDB_USER=${POSTGRES_USER:-n8n}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD:-n8n_password}

      # Execution
      - EXECUTIONS_MODE=regular
      - EXECUTIONS_TIMEOUT=3600
      - EXECUTIONS_TIMEOUT_MAX=7200

      # Security
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-change_this_password}

      # Logging
      - N8N_LOG_LEVEL=info
      - N8N_LOG_OUTPUT=console

      # Optional: Encryption key for credentials
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-generate_random_key_here}

    volumes:
      - n8n_data:/home/node/.n8n
      - ./local-files:/files

    networks:
      - n8n-network

    depends_on:
      - postgres

    # Uncomment if using Traefik for SSL
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.n8n.rule=Host(`${N8N_HOST}`)"
    #   - "traefik.http.routers.n8n.tls=true"
    #   - "traefik.http.routers.n8n.tls.certresolver=le"
    #   - "traefik.http.services.n8n.loadbalancer.server.port=5678"

  # PostgreSQL database for n8n
  postgres:
    image: postgres:15-alpine
    container_name: n8n-postgres
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-n8n}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-n8n_password}
      - POSTGRES_DB=${POSTGRES_DB:-n8n}
      - POSTGRES_NON_ROOT_USER=${POSTGRES_NON_ROOT_USER:-n8n}
      - POSTGRES_NON_ROOT_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD:-n8n}

    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-data.sh:/docker-entrypoint-initdb.d/init-data.sh

    networks:
      - n8n-network

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h localhost -U ${POSTGRES_USER:-n8n} -d ${POSTGRES_DB:-n8n}",
        ]
      interval: 5s
      timeout: 5s
      retries: 10

  # Optional: Traefik reverse proxy for SSL/TLS
  # Uncomment if you want automatic SSL certificates
  # traefik:
  #   image: traefik:v2.10
  #   container_name: traefik
  #   restart: always
  #   command:
  #     - "--api.insecure=true"
  #     - "--providers.docker=true"
  #     - "--providers.docker.exposedbydefault=false"
  #     - "--entrypoints.web.address=:80"
  #     - "--entrypoints.websecure.address=:443"
  #     - "--certificatesresolvers.le.acme.httpchallenge=true"
  #     - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"
  #     - "--certificatesresolvers.le.acme.email=${ACME_EMAIL}"
  #     - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #     - "8080:8080"
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - ./letsencrypt:/letsencrypt
  #   networks:
  #     - n8n-network

volumes:
  n8n_data:
    driver: local
  postgres_data:
    driver: local

networks:
  n8n-network:
    driver: bridge
